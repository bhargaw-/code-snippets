<!DOCTYPE html>
<html lang="en">
<head>
    <title>ATM Subledger Data Migration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
	  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<style>
  .orange {color:orange;}
  .green {color:green;}
  .red {color:red;}
</style>
</head>

<body>

<div class="container">
    <h2> ECMS -> TECMS Data Migration</h2>
    <ul class="nav nav-tabs">
        <li>
            <a data-toggle="tab" href="#menu1"
               onclick="prepareHtml('Cash EOD Balance Migration', 'https://jsonplaceholder.typicode.com/todos/1')">
                Cash EOD Balance Migration
            </a>
        </li>
        <li>
            <a data-toggle="tab" href="#menu1"
               onclick="prepareHtml('Deposit EOD Balance Migration','https://jsonplaceholder.typicode.com/todos123/2')">
                Deposit EOD Balance Migration
            </a>
        </li>
        <li>
            <a data-toggle="tab" href="#menu1"
               onclick="prepareHtml('ATM Reject EOD Balance Migration','https://jsonplaceholder.typicode.com/todos/3')">
                ATM Reject EOD Balance Migration
            </a>
        </li>
		<li>
            <a data-toggle="tab" href="#menu2"
               onclick="prepareHtml('ATM Reject EOD Balance Migration','https://jsonplaceholder.typicode.com/todos/3')">
                ATM Reject EOD Balance Change Status
            </a>
        </li>
		<li>
            <a data-toggle="tab" href="#menu3"
               onclick="prepareHtml('ATM Reject EOD Balance Migration','https://jsonplaceholder.typicode.com/todos/3')">
                ATM Remaping
            </a>
        </li>
		<li>
            <a data-toggle="tab" href="#menu4"
               onclick="prepareHtml('ATM Reject EOD Balance Migration','https://jsonplaceholder.typicode.com/todos/3')">
                ATM Reject Mapping
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <div id="api-response"></div>
        <div id="home" class="tab-pane fade in active">
            <h3>Please select one of tabs above</h3>
        </div>
        <div id="menu1" class="tab-pane fade">
            <h3 id='heading'>Menu 1</h3>
            <div id='add-table'></div>
        </div>
		<div id="menu2" class="tab-pane fade">
            <h3 id='heading'>Page need to be edited</h3>            
        </div>
		<div id="menu3" class="tab-pane fade">
            <h3 id='heading'>Page need to be edited</h3>            
        </div>
		<div id="menu4" class="tab-pane fade">
            <h3 id='heading'>Page need to be edited</h3>            
        </div>
    </div>
</div>
<script type="text/javascript">
    const START_DATE = new Date('2023-01-01');
    const END_DATE = new Date('2023-05-31');
    const DATE_RANGE = 7;
    const apiResponse = document.getElementById('api-response');
    const PENDING = 'PENDING';
    const SUCCESS = 'SUCCESS';
    const FAILURE = 'FAILED';
    const DATA_STORE = new Map();

    window.onbeforeunload = function() {
        return alert();
    }

    function prepareData(url) {
        const PROCESSING_DATES = [];
        let startDate = START_DATE;
        let flag = true;
        while (flag) {
            let processDate = addDate(new Date(startDate), DATE_RANGE);
            if (END_DATE.getTime() < processDate.getTime()) {
                processDate = END_DATE;
                flag = false;
            }
            const date1 = formatDate(startDate);
            const date2 = formatDate(processDate);
            const obj = {};
            obj['startDate'] = date1;
            obj['endDate'] = date2;
            obj['status'] = prepareStatusMessage(PENDING, PENDING);
            obj['apiURL'] = prepareURL(url, date1, date2);
            PROCESSING_DATES.push(obj);
            startDate = addDate(new Date(processDate), 1);
        }
        return PROCESSING_DATES;
    }

    function prepareURL(url, startDate, endDate) {
        const endpointURL = new URL(url);
        endpointURL.searchParams.append("bnkNb", "");
        endpointURL.searchParams.append("postDateFrom", startDate);
        endpointURL.searchParams.append("postDateTo", endDate);
        return endpointURL.href;
    }

    function prepareButton(url, index) {
        return `
            <button onclick = "apiCall('${url}', ${index})" class = 'btn btn-primary'>
                Execute
             </button>
        `;
    }

    function prepareTable(tableData) {
        const tableBody = tableData.map((value, index) => {
			const clsNm = getClasName(value.status);
            return `
                    <tr>
                        <th scope="row">${index + 1}</th>
                        <td>${value.startDate}</td>
                        <td>${value.endDate}</td>
                        <td id = td-s-${index} class='${clsNm}'>${value.status}</td>
                        <td id = td-a-${index}>
                            ${value.status === SUCCESS ? '' : prepareButton(value.apiURL, index)}
                        </td>
                    </tr>
                `;
        });
        return `
            <table class="table">
            <thead>
                  <tr>
                    <td>Serial Number</td>
                    <td>Start Date</td>
                    <td>End Date</td>
                    <td>Status</td>
                    <td>Action</td>
                  </tr>
               </thead>
                <tbody>
                    ${tableBody.join('')}
                </tbody>
            </table>
        `;
    }

    function prepareHtml(title, url) {
        apiResponse.innerHTML = '';
        const heading = document.getElementById('heading');
        heading.innerHTML = `${title}`;
        const div = document.getElementById('add-table');
        div.innerHTML = prepareTable(getItems(url));
    }

    function addDate(date, days) {
        date.setDate(date.getDate() + days);
        return date;
    }

    function formatDate(date) {
        let day = date.getDate();
        let month = date.getMonth() + 1;
        let year = date.getFullYear();
        if (month <= 9) {
            month = `0${month}`;
        }
        if (day <= 9) {
            day = `0${day}`;
        }

        return `${year}-${month}-${day}`;
    }

    function apiCall(url, counter) {
        apiResponse.innerHTML = '';
        alterButton(false);
        console.log("API call is made to ", url);
        fetch(url, {
            method: 'GET',
            mode: "cors",
            cache: 'no-cache',
            headers: {
                Host: 'tecms-trane-db-sync.apps.test.na-7z.gap.jpmchase.net',
                Accept: '*/*',
                'Access-Control-Allow-Origin': '*',
                'Content-Type': 'application/json',
                'Connection': 'keep-alive'
            }
        }).then(response => {            
            if (!response.ok) {			
				const errorMessage = `API call failed. URI : ${url},   Response Status Code : ${response.status},   Reason : ${response.statusText}`;
				throw new Error(errorMessage); 
            }			               
			return response;			           
        })
		.then(response => {		 		 
		 postProcessing(url, counter, SUCCESS);
		})
		.catch(reason => {
			apiResponse.innerHTML = `${prepareStatusMessage(FAILURE, reason)}`;			
            postProcessing(url, counter, FAILURE);            
        });
    }

    function alterButton(flag) {
        const buttons = document.getElementsByTagName('button');
        for (const button of buttons) {
            if (flag){				
                button.removeAttribute('disabled');				
            }else{
                button.setAttribute('disabled','disabled');				
            }
        }
    }

    function postProcessing(url, counter, result) {
        if (result === SUCCESS) {
			apiResponse.innerHTML = `${prepareStatusMessage(SUCCESS, 'Data Migration was successful')}`;
            document.getElementById(`td-a-${counter}`).innerHTML = '';
        }
        document.getElementById(`td-s-${counter}`).innerHTML = prepareStatusMessage(result, result);
        const updatedItems = getItems(url).map((value, index) => {
            if (index === counter) {
                value.status = result;
            }
            return value;
        })
        const origin = url.split('?')[0];
        DATA_STORE.delete(origin);
        DATA_STORE.set(origin, updatedItems);
        alterButton(true);
    }

    function getItems(url) {
        let origin = url.split('?')[0];
        let data = DATA_STORE.get(origin);
        if (data === undefined || data === null) {
            DATA_STORE.set(origin, prepareData(origin));
            data = DATA_STORE.get(origin);
        }
        return data;
    }

    function alert() {
        return  confirm("Do you wan to leave this page?");
    }
	
		
	function prepareStatusMessage(status, reason){				
		return `<p style ='color:${getClasName(status)}'}> ${reason} </p>`;
	}
	
	function getClasName(status){
		let clsColor = 'orange';
		if(status === SUCCESS){
			clsColor = 'green';
		}else if(status === FAILURE){
			clsColor = 'red';
		}	
	  return clsColor;
	}

</script>
</body>
</html>
